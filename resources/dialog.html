<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabinet Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            font-size: 13px;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-weight: 500;
            font-size: 12px;
        }
        
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            margin-bottom: 12px;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
        }
        
        .checkbox-group {
            margin-bottom: 12px;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .checkbox-group label {
            display: inline;
            font-weight: normal;
        }
        
        .radio-group {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
        }
        
        .radio-group input[type="radio"] {
            margin-right: 6px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }
        
        button {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #0078d4;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #006cbe;
        }
        
        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #d0d0d0;
        }
        
        .inline-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .inline-group-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .inline-group-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .help-text {
            font-size: 11px;
            color: #666;
            margin-top: -8px;
            margin-bottom: 12px;
        }
        
        .preset-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .preset-btn {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .preset-btn.active {
            background-color: #0078d4;
            color: white;
            border-color: #0078d4;
        }
        
        #appliance_gaps_container {
            margin-top: 12px;
        }
        
        .appliance-gap-item {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        .appliance-gap-item input {
            margin-bottom: 0;
        }
        
        .appliance-gap-item button {
            padding: 4px 8px;
            font-size: 11px;
            background: #d32f2f;
            color: white;
        }
        
        .add-gap-btn {
            padding: 6px 12px;
            font-size: 12px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .drawer-heights-container {
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-top: 8px;
        }
        
        .drawer-heights-container input[type="number"] {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Cabinet Builder</h2>
        
        <!-- Cabinet Run Management -->
        <div class="section">
            <label>Current Cabinet Run</label>
            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                <select id="current_run" style="flex: 1;">
                    <option value="">Select or create a run...</option>
                </select>
                <button type="button" id="new_run_btn" class="btn-secondary" style="flex: 0 0 auto; padding: 6px 12px;">New</button>
            </div>
            <div id="run_info" style="font-size: 11px; color: #666; display: none;">
                <span id="run_section_count"></span> sections
            </div>
        </div>
        
        <!-- Room Information -->
        <div class="section">
            <label for="room_name">Room Name</label>
            <input type="text" id="room_name" placeholder="e.g., Kitchen, Master Bath" value="Kitchen">
            <p class="help-text">Used for material naming in TwinMotion</p>
            
            <label>Room Preset</label>
            <div class="preset-buttons">
                <button type="button" class="preset-btn active" data-preset="kitchen">Kitchen</button>
                <button type="button" class="preset-btn" data-preset="bathroom">Bathroom</button>
                <button type="button" class="preset-btn" data-preset="closet">Closet</button>
            </div>
            <input type="hidden" id="room_preset" value="kitchen">
        </div>
        
        <!-- Build Mode -->
        <div class="section">
            <label>Build Mode</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="build_mode" value="single" checked>
                    Single Cabinet
                </label>
                <label>
                    <input type="radio" name="build_mode" value="run">
                    Cabinet Run
                </label>
            </div>
        </div>
        
        <!-- Run Connection Options (for single cabinet mode) -->
        <div id="run_connection_options" class="section">
            <label>Cabinet Run Connection</label>
            <div class="radio-group" style="flex-direction: column; gap: 8px;">
                <label>
                    <input type="radio" name="run_connection" value="auto" checked>
                    Auto (extend nearest run)
                </label>
                <label>
                    <input type="radio" name="run_connection" value="new_run">
                    Create new run
                </label>
                <label>
                    <input type="radio" name="run_connection" value="extend_run">
                    Extend specific run
                </label>
            </div>
            
            <div id="run_selector" style="display: none; margin-top: 12px;">
                <label for="target_run">Select Run to Extend</label>
                <select id="target_run">
                    <option value="">-- No runs available --</option>
                </select>
            </div>
        </div>
        
        <!-- Single Cabinet Options -->
        <div id="single_cabinet_options" class="section">
            <label for="cabinet_type">Cabinet Type</label>
            <select id="cabinet_type">
                <option value="base">Base Cabinet</option>
                <option value="wall">Wall Cabinet</option>
                <option value="wall_stack_9ft">Upper 42"+12</option>
                <option value="wall_stack">Upper 42"+12+12</option>
                <option value="island">Island</option>
                <option value="tall">Tall/Pantry</option>
                <option value="corner_base">Corner Base</option>
                <option value="corner_wall">Corner Wall</option>
                <option value="floating">Floating</option>
            </select>
            
            <label for="frame_type">Frame Type</label>
            <select id="frame_type">
                <option value="frameless">Frameless</option>
                <option value="framed">Framed</option>
            </select>
            
            <div class="inline-group-3">
                <div>
                    <label for="width">Width (in)</label>
                    <select id="width">
                        <option value="9">9"</option>
                        <option value="12">12"</option>
                        <option value="15">15"</option>
                        <option value="18">18"</option>
                        <option value="24" selected>24"</option>
                        <option value="30">30"</option>
                        <option value="36">36"</option>
                        <option value="42">42"</option>
                        <option value="48">48"</option>
                        <option value="custom">Custom</option>
                    </select>
                    <input type="number" id="width_custom" style="display:none;" placeholder="Width">
                </div>
                <div>
                    <label for="depth">Depth (in)</label>
                    <input type="number" id="depth" value="24" step="0.5">
                </div>
                <div>
                    <label for="height">Height (in)</label>
                    <input type="number" id="height" value="34.5" step="0.5">
                </div>
            </div>
            
            <label>Cabinet Configuration</label>
            
            <div class="inline-group-2">
                <div>
                    <label for="door_count">Doors</label>
                    <select id="door_count">
                        <option value="0">No Doors</option>
                        <option value="1" selected>1 Door</option>
                        <option value="2">2 Doors</option>
                    </select>
                </div>
                <div>
                    <label for="drawer_count">Drawers</label>
                    <select id="drawer_count">
                        <option value="0" selected>No Drawers</option>
                        <option value="1">1 Drawer</option>
                        <option value="2">2 Drawers</option>
                        <option value="3">3 Drawers</option>
                        <option value="4">4 Drawers</option>
                        <option value="5">5 Drawers</option>
                    </select>
                </div>
            </div>
            
            <div id="drawer_sizing_options" style="display:none;">
                <label for="drawer_sizing">Drawer Sizing</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="drawer_sizing" value="equal" checked>
                        Equal Height
                    </label>
                    <label>
                        <input type="radio" name="drawer_sizing" value="graduated">
                        Graduated (Small to Large)
                    </label>
                    <label>
                        <input type="radio" name="drawer_sizing" value="custom">
                        Custom Heights
                    </label>
                </div>
            </div>
            
            <div id="custom_drawer_heights" style="display:none; margin-top: 12px;">
                <label>Custom Drawer Heights (inches)</label>
                <div id="drawer_height_inputs" class="drawer-heights-container">
                    <!-- Dynamic inputs will be added here -->
                </div>
                <div id="height_validation" style="color: #e74c3c; font-size: 12px; margin-top: 4px;"></div>
            </div>
            
            <div id="layout_options" style="display:none; margin-top: 12px;">
                <label for="layout_order">Layout</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="layout_order" value="drawers_top" checked>
                        Drawers on Top
                    </label>
                    <label>
                        <input type="radio" name="layout_order" value="doors_top">
                        Doors on Top
                    </label>
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="has_countertop" checked>
                <label for="has_countertop">Include Countertop</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="has_backsplash" checked>
                <label for="has_backsplash">Include Backsplash</label>
            </div>
            
            <!-- Corner Cabinet Options -->
            <div id="corner_options" style="display:none;">
                <label for="corner_type">Corner Type</label>
                <select id="corner_type">
                    <option value="blind">Blind Corner</option>
                    <option value="lazy_susan">Lazy Susan</option>
                </select>
            </div>
            
            <!-- Island Options -->
            <div id="island_options" style="display:none;">
                <div class="checkbox-group">
                    <input type="checkbox" id="has_seating_side">
                    <label for="has_seating_side">Include Seating Overhang</label>
                </div>
            </div>
        </div>
        
        <!-- Cabinet Run Options -->
        <div id="cabinet_run_options" class="section" style="display:none;">
            <label for="run_length">Total Run Length (in)</label>
            <input type="number" id="run_length" value="120" step="1">
            <p class="help-text">Total length available for cabinets</p>
            
            <label for="run_cabinet_type">Cabinet Type</label>
            <select id="run_cabinet_type">
                <option value="base">Base Cabinets</option>
                <option value="wall">Wall Cabinets</option>
            </select>
            
            <label for="run_frame_type">Frame Type</label>
            <select id="run_frame_type">
                <option value="frameless">Frameless</option>
                <option value="framed">Framed</option>
            </select>
            
            <div class="checkbox-group">
                <input type="checkbox" id="run_has_countertop" checked>
                <label for="run_has_countertop">Include Countertop</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="run_has_backsplash" checked>
                <label for="run_has_backsplash">Include Backsplash</label>
            </div>
            
            <label>Appliance Gaps</label>
            <p class="help-text">Add spaces for ranges, dishwashers, etc.</p>
            <div id="appliance_gaps_container"></div>
            <button type="button" class="add-gap-btn" onclick="addApplianceGap()">+ Add Appliance Gap</button>
        </div>
        
        <!-- Buttons -->
        <div class="button-group">
            <button type="button" class="btn-secondary" onclick="cancel()">Cancel</button>
            <button type="button" class="btn-primary" onclick="createCabinet()">Create Cabinet</button>
        </div>
    </div>
    
    <script>
        let applianceGapCount = 0;
        let existingRuns = [];
        let currentRun = null;
        
        // Load existing runs when dialog opens
        window.addEventListener('load', function() {
            sketchup.get_existing_runs();
            sketchup.get_current_run();
        });
        
        // Receive existing runs from Ruby
        function receiveExistingRuns(runs) {
            existingRuns = runs;
            updateRunSelectors();
        }
        
        // Receive current run info from Ruby
        function receiveCurrentRun(run) {
            currentRun = run;
            updateCurrentRunDisplay();
        }
        
        // Update current run display
        function updateCurrentRunDisplay() {
            const selector = document.getElementById('current_run');
            const runInfo = document.getElementById('run_info');
            const sectionCount = document.getElementById('run_section_count');
            
            if (currentRun) {
                selector.value = currentRun.id;
                runInfo.style.display = 'block';
                sectionCount.textContent = currentRun.section_count;
            } else {
                selector.value = '';
                runInfo.style.display = 'none';
            }
        }
        
        // Update run selector dropdowns
        function updateRunSelectors() {
            // Update current run selector
            const currentSelector = document.getElementById('current_run');
            currentSelector.innerHTML = '<option value="">-- Create new run --</option>';
            
            existingRuns.forEach(run => {
                const option = document.createElement('option');
                option.value = run.id;
                option.textContent = `${run.room_name} - ${run.name}`;
                currentSelector.appendChild(option);
            });
            
            if (currentRun) {
                currentSelector.value = currentRun.id;
            }
            
            // Update target run selector (for extending)
            const targetSelector = document.getElementById('target_run');
            if (targetSelector) {
                targetSelector.innerHTML = '';
                
                if (existingRuns.length === 0) {
                    targetSelector.innerHTML = '<option value="">-- No runs available --</option>';
                } else {
                    existingRuns.forEach(run => {
                        const option = document.createElement('option');
                        option.value = run.id;
                        option.textContent = `${run.room_name} - ${run.name} (${run.section_count} sections)`;
                        targetSelector.appendChild(option);
                    });
                }
            }
        }
        
        // Run connection mode handling
        document.querySelectorAll('input[name="run_connection"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const runSelector = document.getElementById('run_selector');
                if (this.value === 'extend_run') {
                    runSelector.style.display = 'block';
                    // Refresh the list of runs
                    sketchup.get_existing_runs();
                } else {
                    runSelector.style.display = 'none';
                }
            });
        });
        
        // Preset button handling
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('room_preset').value = this.dataset.preset;
                applyRoomPreset(this.dataset.preset);
            });
        });
        
        // Run management event handlers
        document.getElementById('current_run').addEventListener('change', function() {
            if (this.value) {
                sketchup.select_run(this.value);
            }
        });
        
        document.getElementById('new_run_btn').addEventListener('click', function() {
            const roomName = document.getElementById('room_name').value || 'Kitchen';
            const runName = prompt('Enter name for new cabinet run:', `Run ${existingRuns.length + 1}`);
            if (runName) {
                sketchup.create_run(JSON.stringify({ name: runName, room_name: roomName }));
            }
        });
        
        // Room name change updates current run if it exists
        document.getElementById('room_name').addEventListener('change', function() {
            if (currentRun) {
                // Update current run's room name
                // This will be handled automatically when creating new cabinets
            }
        });
        
        // Build mode toggle
        document.querySelectorAll('input[name="build_mode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const runConnectionOptions = document.getElementById('run_connection_options');
                if (this.value === 'single') {
                    document.getElementById('single_cabinet_options').style.display = 'block';
                    document.getElementById('cabinet_run_options').style.display = 'none';
                    runConnectionOptions.style.display = 'block';
                } else {
                    document.getElementById('single_cabinet_options').style.display = 'none';
                    document.getElementById('cabinet_run_options').style.display = 'block';
                    runConnectionOptions.style.display = 'none';
                }
            });
        });
        
        // Drawer count change - show/hide sizing and layout options
        document.getElementById('drawer_count').addEventListener('change', function() {
            const drawerCount = parseInt(this.value);
            const doorCount = parseInt(document.getElementById('door_count').value);
            
            // Show drawer sizing options if drawers selected
            document.getElementById('drawer_sizing_options').style.display = drawerCount > 0 ? 'block' : 'none';
            
            // Update custom height inputs
            updateCustomHeightInputs(drawerCount);
            
            // Show layout options if both doors and drawers selected
            document.getElementById('layout_options').style.display = (drawerCount > 0 && doorCount > 0) ? 'block' : 'none';
        });
        
        // Handle drawer sizing radio change
        document.querySelectorAll('input[name="drawer_sizing"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const customHeightsDiv = document.getElementById('custom_drawer_heights');
                customHeightsDiv.style.display = this.value === 'custom' ? 'block' : 'none';
            });
        });
        
        // Door count change - show/hide layout options
        document.getElementById('door_count').addEventListener('change', function() {
            const doorCount = parseInt(this.value);
            const drawerCount = parseInt(document.getElementById('drawer_count').value);
            
            // Show layout options if both doors and drawers selected
            document.getElementById('layout_options').style.display = (drawerCount > 0 && doorCount > 0) ? 'block' : 'none';
        });
        
        // Cabinet type changes
        document.getElementById('cabinet_type').addEventListener('change', function() {
            const isCorner = this.value === 'corner_base' || this.value === 'corner_wall';
            const isIsland = this.value === 'island';
            
            document.getElementById('corner_options').style.display = isCorner ? 'block' : 'none';
            document.getElementById('island_options').style.display = isIsland ? 'block' : 'none';
            
            // Update default dimensions based on type
            updateDefaultDimensions(this.value);
        });
        
        // Function to update custom height inputs based on drawer count
        function updateCustomHeightInputs(count) {
            const container = document.getElementById('drawer_height_inputs');
            container.innerHTML = '';
            
            if (count > 0) {
                for (let i = 0; i < count; i++) {
                    const inputDiv = document.createElement('div');
                    inputDiv.style.marginBottom = '8px';
                    
                    const label = document.createElement('label');
                    label.textContent = `Drawer ${i + 1}: `;
                    label.style.display = 'inline-block';
                    label.style.width = '80px';
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `drawer_height_${i}`;
                    input.step = '0.125';
                    input.min = '2';
                    input.style.width = '80px';
                    input.placeholder = 'Height';
                    
                    inputDiv.appendChild(label);
                    inputDiv.appendChild(input);
                    container.appendChild(inputDiv);
                }
            }
        }
        
        // Function to validate custom heights
        function validateCustomHeights(drawerCount, availableHeight) {
            const heights = [];
            let totalHeight = 0;
            
            for (let i = 0; i < drawerCount; i++) {
                const input = document.getElementById(`drawer_height_${i}`);
                const value = parseFloat(input.value);
                
                if (isNaN(value) || value < 2) {
                    return { valid: false, message: `Drawer ${i + 1} height must be at least 2 inches` };
                }
                
                heights.push(value);
                totalHeight += value;
            }
            
            const tolerance = 0.25; // Allow 1/4" tolerance
            if (Math.abs(totalHeight - availableHeight) > tolerance) {
                return {
                    valid: false,
                    message: `Total height (${totalHeight.toFixed(2)}") must equal available height (${availableHeight.toFixed(2)}"). Difference: ${(totalHeight - availableHeight).toFixed(2)}"`
                };
            }
            
            return { valid: true, heights: heights };
        }
        
        // Width selector
        document.getElementById('width').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('width_custom').style.display = 'block';
            } else {
                document.getElementById('width_custom').style.display = 'none';
            }
        });
        
        // Apply room preset dimensions
        function applyRoomPreset(preset) {
            const cabinetType = document.getElementById('cabinet_type').value;
            
            if (preset === 'kitchen') {
                if (cabinetType === 'base') {
                    document.getElementById('depth').value = 24;
                } else if (cabinetType === 'wall') {
                    document.getElementById('depth').value = 12;
                    document.getElementById('height').value = 36;
                }
            } else if (preset === 'bathroom') {
                if (cabinetType === 'base') {
                    document.getElementById('depth').value = 21;
                } else if (cabinetType === 'wall') {
                    document.getElementById('depth').value = 12;
                    document.getElementById('height').value = 30;
                }
            } else if (preset === 'closet') {
                if (cabinetType === 'base') {
                    document.getElementById('depth').value = 24;
                } else if (cabinetType === 'wall') {
                    document.getElementById('depth').value = 14;
                    document.getElementById('height').value = 42;
                }
            }
        }
        
        // Update default dimensions based on cabinet type
        function updateDefaultDimensions(type) {
            switch(type) {
                case 'base':
                    document.getElementById('depth').value = 24;
                    document.getElementById('height').value = 34.5;
                    break;
                case 'wall':
                    document.getElementById('depth').value = 12;
                    document.getElementById('height').value = 36;
                    break;
                case 'island':
                    document.getElementById('depth').value = 36;
                    document.getElementById('height').value = 34.5;
                    break;
                case 'tall':
                    document.getElementById('depth').value = 24;
                    document.getElementById('height').value = 84;
                    break;
                case 'corner_base':
                case 'corner_wall':
                    document.getElementById('width').value = '42';
                    document.getElementById('depth').value = 42;
                    break;
                case 'floating':
                    document.getElementById('depth').value = 12;
                    document.getElementById('height').value = 36;
                    break;
            }
        }
        
        // Add appliance gap
        function addApplianceGap() {
            applianceGapCount++;
            const container = document.getElementById('appliance_gaps_container');
            const div = document.createElement('div');
            div.className = 'appliance-gap-item';
            div.innerHTML = `
                <input type="number" placeholder="Position (in)" data-gap-id="${applianceGapCount}" data-gap-field="position" style="flex:1">
                <input type="number" placeholder="Width (in)" data-gap-id="${applianceGapCount}" data-gap-field="width" style="flex:1">
                <input type="text" placeholder="Label" data-gap-id="${applianceGapCount}" data-gap-field="label" style="flex:1">
                <button onclick="removeApplianceGap(this)">Remove</button>
            `;
            container.appendChild(div);
        }
        
        // Remove appliance gap
        function removeApplianceGap(btn) {
            btn.parentElement.remove();
        }
        
        // Create cabinet
        function createCabinet() {
            const buildMode = document.querySelector('input[name="build_mode"]:checked').value;
            const data = {
                room_name: document.getElementById('room_name').value,
                room_preset: document.getElementById('room_preset').value,
                build_mode: buildMode
            };
            
            if (buildMode === 'single') {
                // Get run connection option
                const runConnection = document.querySelector('input[name="run_connection"]:checked').value;
                data.run_connection = runConnection;
                
                if (runConnection === 'extend_run') {
                    data.target_run = document.getElementById('target_run').value;
                    if (!data.target_run) {
                        alert('Please select a run to extend');
                        return;
                    }
                }
                
                // Get width
                let width = document.getElementById('width').value;
                if (width === 'custom') {
                    width = document.getElementById('width_custom').value;
                }
                
                // Build door/drawer configuration from separate controls
                const doorCount = parseInt(document.getElementById('door_count').value);
                const drawerCount = parseInt(document.getElementById('drawer_count').value);
                const drawerSizing = document.querySelector('input[name="drawer_sizing"]:checked')?.value || 'equal';
                const layoutOrder = document.querySelector('input[name="layout_order"]:checked')?.value || 'drawers_top';
                
                // Collect custom drawer heights if applicable
                let customDrawerHeights = null;
                if (drawerSizing === 'custom' && drawerCount > 0 && doorCount === 0) {
                    const height = parseFloat(document.getElementById('height').value);
                    const cabinetType = document.getElementById('cabinet_type').value;
                    
                    // Calculate available height for drawers
                    let availableHeight = height;
                    if (cabinetType === 'base' || cabinetType === 'island') {
                        availableHeight -= 4; // Subtract toe kick height
                    }
                    
                    const validation = validateCustomHeights(drawerCount, availableHeight);
                    if (!validation.valid) {
                        document.getElementById('height_validation').textContent = validation.message;
                        return; // Don't submit
                    }
                    
                    customDrawerHeights = validation.heights;
                    document.getElementById('height_validation').textContent = '';
                }
                
                //Debug output
                console.log('Dialog values:', { doorCount, drawerCount, drawerSizing, layoutOrder, customDrawerHeights });
                console.log('==> CREATING CABINET WITH: Doors=' + doorCount + ', Drawers=' + drawerCount);
                
                // Don't build config string here - let Ruby do it to avoid URL encoding issues
                // Just pass the raw values
                
                data.cabinet = {
                    type: document.getElementById('cabinet_type').value,
                    frame_type: document.getElementById('frame_type').value,
                    width: parseFloat(width),
                    depth: parseFloat(document.getElementById('depth').value),
                    height: parseFloat(document.getElementById('height').value),
                    door_count: doorCount,
                    drawer_count: drawerCount,
                    drawer_sizing: drawerSizing,
                    custom_drawer_heights: customDrawerHeights,
                    layout_order: layoutOrder,
                    has_countertop: document.getElementById('has_countertop').checked,
                    has_backsplash: document.getElementById('has_backsplash').checked,
                    corner_type: document.getElementById('corner_type').value,
                    has_seating_side: document.getElementById('has_seating_side').checked
                };
            } else {
                // Cabinet run
                const applianceGaps = [];
                document.querySelectorAll('#appliance_gaps_container .appliance-gap-item').forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 3 && inputs[0].value && inputs[1].value) {
                        applianceGaps.push({
                            position: parseFloat(inputs[0].value),
                            width: parseFloat(inputs[1].value),
                            label: inputs[2].value || 'Appliance'
                        });
                    }
                });
                
                data.cabinet_run = {
                    total_length: parseFloat(document.getElementById('run_length').value),
                    cabinet_type: document.getElementById('run_cabinet_type').value,
                    frame_type: document.getElementById('run_frame_type').value,
                    has_countertop: document.getElementById('run_has_countertop').checked,
                    has_backsplash: document.getElementById('run_has_backsplash').checked,
                    appliance_gaps: applianceGaps
                };
            }
            
            // Send to Ruby - use encodeURIComponent to preserve special characters like +
            window.location = 'skp:create_cabinet@' + encodeURIComponent(JSON.stringify(data));
        }
        
        // Cancel
        function cancel() {
            window.location = 'skp:cancel@';
        }
    </script>
</body>
</html>
